---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Setup
```{r}
library(tidyverse)
library(DataExplorer)
library(ggplot2)
```

Import data 
```{r}
df <- read.csv("capstone_repository/data/ratios_return.csv")
dim(df)#10788    35
colnames(df)
```

Keeps rows in Technology Sector
```{r}
tech <- subset(df, Sector == 'Technology')
dim(tech)# 2085   35
```






#####################################################################Operating.Profit.Margin###############################################

Outliers on the left side 
```{r}
summary(tech$Operating.Profit.Margin)
#     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
#-12.07678   0.01599   0.08713   0.04513   0.17861   0.62948 

#check distribuion
ggplot(tech)+ geom_histogram(aes(x=Operating.Profit.Margin)) 
```


After removing observation smaller than -1, the distribution is slightly left skewed
most observations are around 0
we may want to try some transformations
```{r}
#arbitrily choose a subset 
OPM.sub <- tech$Operating.Profit.Margin[tech$Operating.Profit.Margin >-1]

ggplot(tech[tech$Operating.Profit.Margin > -1,]) + geom_histogram(aes(x = Operating.Profit.Margin))
```



Cube transformation doesn't work
```{r}
#function for cube transformation
Math.cbrt <- function(x) {
    sign(x) * abs(x)^(1/3)
}

tech$Operating.Profit.Margin.cube <- Math.cbrt(tech$Operating.Profit.Margin)
ggplot(tech[tech$Operating.Profit.Margin > -1,]) + geom_histogram(aes(x = Operating.Profit.Margin.cube)) #doesn't work
```





log transformation, doesn't help either 
```{r}
Math.log <- function(x){
  min_x <- min(x)
  log(x + abs(min_x) + 0.1)
}


tech$Operating.Profit.Margin.log <- Math.log(tech$Operating.Profit.Margin)
summary(tech$Operating.Profit.Margin.log)
ggplot(tech[tech$Operating.Profit.Margin > -1,]) + geom_histogram(aes(x = Operating.Profit.Margin.log)) #doesn't work
```


So we will not do any transfrmation on this data but instead remove several outliers. 
```{r}
sd <- sd(tech$Operating.Profit.Margin) #0.4783343
mean <- mean(tech$Operating.Profit.Margin) # 0.04513398
ci <- c(mean - 3*sd, mean + 3*sd) #-1.389869  1.480137
sum(!tech$Operating.Profit.Margin %between% ci)#15 outliers

#get the id of these outliers
Operating.Profit.Margin.outid <- tech[!tech$Operating.Profit.Margin %between% ci, c('Ticker', 'Fiscal.Year')]
```







#############################################################################

Return.On.Capital
```{r}
summary(tech$Return.On.Capital)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#-6.2459  0.1449  0.3547  0.6844  0.7674 40.5840 

#check distribuion
ggplot(tech)+ geom_histogram(aes(x=Return.On.Capital)) 
#it seems that there are a few outliers 
#but how many are there?

cor(tech$Return.On.Capital,tech$Return) #-0.01206171
```


After removing 29 outliers, the distribution is still pretty right skewed
```{r}
#find outliers
sd <- sd(tech$Return.On.Capital) #1.492936
mean <- mean(tech$Return.On.Capital) # 0.6843845
ci <- c(mean - 3*sd, mean + 3*sd) #-3.794422  5.163191
sum(!tech$Return.On.Capital %between% ci)#29 outliers


#even after removing outliers the data is still pretty right skewed 
ggplot(tech[tech$Return.On.Capital %between% ci,]) + geom_histogram(aes(x = Return.On.Capital))
```

Try cube transformation
still has 35 outliers after transformation in terms of standard deviation
The correlaition is improved but still minor
but the distribution looks pretty good, so we are not removing any outliers
```{r}
tech$Return.On.Capital.cube <- Math.cbrt(tech$Return.On.Capital)

cor(tech$Return.On.Capital.cube, tech$Return) #-0.04938463 

sd_cube <- sd(tech$Return.On.Capital.cube)
mean <- mean(tech$Return.On.Capital.cube)
ci <- c(mean - 3*sd_cube, mean + 3* sd_cube)
sum(!tech$Return.On.Capital.cube %between% ci) #still has 35 outliers 

#plot distribution
ggplot(tech) + geom_histogram(aes(x = Return.On.Capital.cube))
```

log transformation doesn't help
```{r}
tech$Return.On.Capital.log <- Math.log(tech$Return.On.Capital)
ggplot(tech) + geom_histogram(aes(x = Return.On.Capital.log))
```





######################################################################
Return.On.Equity
```{r}
summary(tech$Return.On.Equity)
#    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#-10.9390   0.3338   0.6366   1.7241   1.2909 964.7980 

cor(tech$Return.On.Equity, tech$Return) #-0.001948035

#check distribuion
ggplot(tech)+ geom_histogram(aes(x=Return.On.Equity)) 
#it seems that there are a few outliers 
#but how many are there?
```


There is one very big outlier, remove it because it is way beyond the range.
51 observations are beyond 3 sd from the mean
after removing these outliers, the distribution is still right skewed. 
```{r}
tech$Return.On.Equity[tech$Return.On.Equity > 30] #54.64788  48.33061  41.95200 964.79796



#find outliers
sd <- sd(tech$Return.On.Equity[tech$Return.On.Equity < 30]) #2.007913
mean <- mean(tech$Return.On.Equity[tech$Return.On.Equity < 30]) #1.195676
ci <- c(mean - 3*sd, mean + 3*sd) #-4.828064  7.219416
sum(!tech$Return.On.Equity %between% ci)#51 outliers


#even after removing outliers the data is still pretty right skewed 
ggplot(tech[tech$Return.On.Equity %between% ci,]) + geom_histogram(aes(x = Return.On.Equity))

```


Cube transformation helps, although we still have 254 observations outside 3 sd
We need to remove one giant outlier, the ticker and year is given below

```{r}
tech$Return.On.Equity.cube <- Math.cbrt(tech$Return.On.Equity)


#find outliers
sd <- sd(tech$Return.On.Equity.cube) #0.5669262
mean <- mean(tech$Return.On.Equity.cube) #0.87069
ci <- c(mean - 3*sd, mean + 3*sd) #-0.8300888  2.5714687
sum(!tech$Return.On.Equity %between% ci)#254 outliers


summary(tech$Return.On.Equity.cube)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#-2.2199  0.6937  0.8603  0.8707  1.0889  9.8813 
   
   
ggplot(tech[tech$Return.On.Equity.cube < 8,]) + geom_histogram(aes(x = Return.On.Equity.cube))
```

log doesn't work as good as cube 
```{r}
tech$Return.On.Equity.log <- Math.log(tech$Return.On.Equity)

   
ggplot(tech) + geom_histogram(aes(x = Return.On.Equity.log))
```



```{r}
#get the id of these outliers
Return.on.Equity.out <- tech[tech$Return.On.Equity.cube > 8,c('Ticker', 'Fiscal.Year')]
```




#########################################################################################
Receivable.Turnover
there is outliers, not very high correlation. 
```{r}
summary(tech$Receivable.Turnover)
#Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#0.21     5.45     7.00    30.74     9.39 37975.57

#check distribuion
ggplot(tech)+ geom_histogram(aes(x=Receivable.Turnover)) 
#it seems that there is a very large
#but how many are there?

cor(tech$Receivable.Turnover, tech$Return) #-0.001375046
```



The distribution is very right skewed, and there are three very huge outliers
```{r}
sum(tech$Receivable.Turnover > 300) #9


#even after removing outliers the data is still pretty right skewed 
ggplot(tech[tech$Return.On.Equity %between% ci,]) + geom_histogram(aes(x = Return.On.Equity))
```

Try cube transformation, still right skewed, doesn't work well
```{r}
tech$Receivable.Turnover.cube <- Math.cbrt(tech$Receivable.Turnover)
summary(tech$Receivable.Turnover.cube)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.5901  1.7595  1.9125  2.0384  2.1094 33.6125  
ggplot(tech[tech$Receivable.Turnover < 300,]) + geom_histogram(aes(x = Receivable.Turnover.cube))
```


Try log transformation, pretty symmetric after removing 9 observations larger than 300
```{r}
tech$Receivable.Turnover.log <- log(tech$Receivable.Turnover)
summary(tech$Receivable.Turnover.log)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# -1.582   1.695   1.945   2.032   2.239  10.545 



#find outliers
length(tech$Receivable.Turnover.log[tech$Receivable.Turnover.log > 5]) #11
sd <- sd(tech$Receivable.Turnover.log[tech$Receivable.Turnover.log < 5]) # 0.5928083
mean <- mean(tech$Receivable.Turnover.log[tech$Receivable.Turnover.log < 5]) #2.008366
ci <- c(mean - 3*sd, mean + 3*sd) #0.229941 3.786791
sum(!tech$Receivable.Turnover.log %between% ci)#60 outliers


#but the distribution looks pretty after only removing 9 observations
ggplot(tech[tech$Receivable.Turnover < 300,]) + geom_histogram(aes(x = Receivable.Turnover.log))
```

get the key for outliers 
```{r}
Receivable.Turnover.out <- tech[tech$Receivable.Turnover > 300,c('Ticker', 'Fiscal.Year')]
```




Book.to.Market.Ratio
```{r}
summary(tech$Book.to.Market.Ratio)
#     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
#   0.0042    0.1959    0.3429    2.8065    0.6150 1326.5407 

#check distribuion
ggplot(tech)+ geom_histogram(aes(x=Book.to.Market.Ratio)) 
#it seems that there is a very large
#but how many are there?
```


Right skewed distribution
```{r}
#the first histogram shows to be pretty rights skewed, so we set a arbitrary cut off at 10
sum(tech$Book.to.Market.Ratio > 10) #11

#even after removing observations > 10 the data is still pretty right skewed 
ggplot(tech[tech$Book.to.Market.Ratio <10,]) + geom_histogram(aes(x = Book.to.Market.Ratio))
```


Try cube transformation
After removing 11 observations larger than 10, the distribution is pretty symmetric 
```{r}
tech$Book.to.Market.Ratio.cube <- Math.cbrt(tech$Book.to.Market.Ratio)
ggplot(tech) + geom_histogram(aes(x = Book.to.Market.Ratio.cube))


summary(tech$Book.to.Market.Ratio.cube)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.1611  0.5808  0.6999  0.7470  0.8504 10.9877 
sum(tech$Book.to.Market.Ratio.cube >2) #11


ggplot(tech[tech$Book.to.Market.Ratio < 10,]) + geom_histogram(aes(x = Book.to.Market.Ratio.cube))
```



Try log transformation, works better, with wider range
```{r}
tech$Book.to.Market.Ratio.log <- Math.log(tech$Book.to.Market.Ratio)
ggplot(tech) + geom_histogram(aes(x = Book.to.Market.Ratio.log))


sd <- sd(tech$Book.to.Market.Ratio.log) # 0.762692
mean <- mean(tech$Book.to.Market.Ratio.log) #-0.7379935
ci <- c(mean - 3*sd, mean + 3*sd) #-3.026069  1.550082
sum(!tech$Book.to.Market.Ratio.log %between% ci)#14 outliers


ggplot(tech[tech$Book.to.Market.Ratio %between% ci,]) + geom_histogram(aes(x = Book.to.Market.Ratio.log))
```



